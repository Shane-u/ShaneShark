name: Deploy Backend to Server

on:
  push:
    branches: [ "main", "master" ]
    paths:
      - 'backend/**'
      - '.github/workflows/backend-deploy.yml'
  workflow_dispatch:

env:
  APP_NAME: shaneshark-backend
  APP_PORT: 8121
  DEPLOY_PATH: /opt/shaneshark
  JAR_NAME: shaneShark-0.0.1-SNAPSHOT.jar

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: backend

    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 设置 Java 17 环境
        uses: actions/setup-java@v4
        with:
          java-version: 17
          distribution: temurin
          cache: maven

      - name: Maven 构建（包含测试）
        run: mvn -B -ntp clean package

      - name: 配置 SSH 凭据
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: 加入服务器指纹
        run: ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts
        shell: bash

      - name: 传输 JAR 文件到服务器
        env:
          SSH_TARGET: ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}
        run: |
          scp backend/target/${{ env.JAR_NAME }} "$SSH_TARGET:${{ env.DEPLOY_PATH }}/app.jar"

      - name: 远程部署应用
        env:
          SSH_TARGET: ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}
          APP_NAME: ${{ env.APP_NAME }}
          DEPLOY_PATH: ${{ env.DEPLOY_PATH }}
          APP_PORT: ${{ env.APP_PORT }}
        run: |
          ssh "$SSH_TARGET" bash -s << 'REMOTE_SCRIPT'
            set -e
            APP_NAME="${{ env.APP_NAME }}"
            DEPLOY_PATH="${{ env.DEPLOY_PATH }}"
            
            # 确保部署目录存在
            mkdir -p "$DEPLOY_PATH"
            
            # 停止旧进程（如果存在）
            if systemctl is-active --quiet "$APP_NAME" 2>/dev/null; then
              echo "停止 systemd 服务..."
              systemctl stop "$APP_NAME" || true
            fi
            
            # 查找并停止可能正在运行的 Java 进程
            OLD_PID=$(pgrep -f "java.*app.jar" || true)
            if [ ! -z "$OLD_PID" ]; then
              echo "停止旧进程 PID: $OLD_PID"
              kill -15 "$OLD_PID" || true
              sleep 2
              if kill -0 "$OLD_PID" 2>/dev/null; then
                kill -9 "$OLD_PID" || true
              fi
            fi
            
            # 检查 systemd 服务文件是否存在，不存在则创建
            SERVICE_FILE="/etc/systemd/system/${APP_NAME}.service"
            if [ ! -f "$SERVICE_FILE" ]; then
              echo "创建 systemd 服务文件..."
              sudo tee "$SERVICE_FILE" > /dev/null <<EOF
[Unit]
Description=ShaneShark Backend Application
After=network.target

[Service]
Type=simple
User=root
WorkingDirectory=$DEPLOY_PATH
EnvironmentFile=/root/envFiles/.env
ExecStart=/usr/bin/java -jar $DEPLOY_PATH/app.jar
Restart=always
RestartSec=10
StandardOutput=journal
StandardError=journal

[Install]
WantedBy=multi-user.target
EOF
              systemctl daemon-reload
              systemctl enable "$APP_NAME"
            fi
            
            # 启动服务
            echo "启动应用服务..."
            systemctl start "$APP_NAME"
            
            # 等待服务启动
            sleep 3
            
            # 检查服务状态
            if systemctl is-active --quiet "$APP_NAME"; then
              echo "应用启动成功！"
              systemctl status "$APP_NAME" --no-pager -l
            else
              echo "应用启动失败，查看日志："
              journalctl -u "$APP_NAME" -n 50 --no-pager
              exit 1
            fi
          REMOTE_SCRIPT

