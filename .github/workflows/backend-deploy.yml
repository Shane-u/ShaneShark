name: Deploy Backend to Server

on:
  push:
    branches: [ "main", "master" ]
    paths:
      - 'backend/**'
      - '.github/workflows/backend-deploy.yml'
  workflow_dispatch:

env:
  IMAGE_NAME: shaneshark-backend
  IMAGE_TAG: latest
  CONTAINER_NAME: shaneshark-backend
  APP_PORT: 8121
  DOCKER_PROXY_PREFIX: registry.cn-hangzhou.aliyuncs.com/

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: backend

    steps:
      - name: 配置 Docker 镜像加速器（使用阿里云）
        run: |
          sudo mkdir -p /etc/docker
          sudo tee /etc/docker/daemon.json <<-'EOF'
          {
            "registry-mirrors": ["https://e6wr6pq8.mirror.aliyuncs.com/", "https://docker.registry.cyou/", "https://docker-cf.registry.cyou/"]
          }
          EOF
          sudo systemctl daemon-reload
          sudo systemctl restart docker
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 设置 Java 17 环境
        uses: actions/setup-java@v4
        with:
          java-version: 17
          distribution: temurin
          cache: maven

      - name: Maven 构建（包含测试）
        run: mvn -B -ntp clean package

      - name: 准备 Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: 登录 Docker Registry
        uses: docker/login-action@v3
        with:
          registry: docker.io
          username: ${{ secrets.DOCKER_HUB_USER }}
          password: ${{ secrets.DOCKER_HUB_TOKEN }}

      - name: 构建并推送镜像
        uses: docker/build-push-action@v5
        with:
          context: backend
          file: backend/Dockerfile
          push: true
          tags: ${{ secrets.DOCKER_HUB_USER }}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}
          build-args: |
            JAR_FILE=target/*.jar

      - name: 配置 SSH 凭据
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: 加入服务器指纹
        run: ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts
        shell: bash

      - name: 远程更新容器
        env:
          SSH_TARGET: ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}
          DOCKER_IMAGE: ${{ secrets.DOCKER_HUB_USER }}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}
          DOCKER_PROXY_IMAGE: ${{ env.DOCKER_PROXY_PREFIX }}${{ secrets.DOCKER_HUB_USER }}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}
        run: |
          ssh "$SSH_TARGET" <<EOF
            set -e
            if ! docker pull $DOCKER_IMAGE; then
              echo "Primary registry pull failed, trying proxy $DOCKER_PROXY_IMAGE"
              docker pull $DOCKER_PROXY_IMAGE
              docker tag $DOCKER_PROXY_IMAGE $DOCKER_IMAGE
              docker rmi $DOCKER_PROXY_IMAGE || true
            fi
            docker stop ${{ env.CONTAINER_NAME }} || true
            docker rm ${{ env.CONTAINER_NAME }} || true
            docker run -d \
              --name ${{ env.CONTAINER_NAME }} \
              --restart=always \
              -p ${{ env.APP_PORT }}:${{ env.APP_PORT }} \
              --env-file /root/envFiles/.env \
              $DOCKER_IMAGE
          EOF

